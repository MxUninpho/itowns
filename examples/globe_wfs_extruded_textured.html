<html>
    <head>
        <title>Itowns - Globe + WFS</title>

        <meta charset="UTF-8">
        <link rel="stylesheet" type="text/css" href="css/example.css">
        <link rel="stylesheet" type="text/css" href="css/loading_screen.css">

        <meta name="viewport" content="width=device-width, initial-scale=1.0">
    </head>
    <body>
        <div id="viewerDiv"></div>
        <script src="../dist/itowns.js"></script>
        <script src="js/GUI/dat.gui/dat.gui.min.js"></script>
        <script src="js/GUI/GuiTools.js"></script>
        <script src="../dist/debug.js"></script>
        <script type="text/javascript">
            // Define initial camera position
            var positionOnGlobe = { longitude: 2.33481381638492, latitude: 48.850602961052147, altitude: 50 };

            var promises = [];

            // `viewerDiv` will contain iTowns' rendering area (`<canvas>`)
            var viewerDiv = document.getElementById('viewerDiv');

            var orientedImageLayer;

            // Instanciate iTowns GlobeView*
            var globeView = new itowns.GlobeView(viewerDiv, positionOnGlobe, {
                noControls: true,
                handleCollision: false,
                sseSubdivisionThreshold: 10,
            });

            // create Immersive control
            var immersiveControl = new itowns.ImmersiveControls(globeView, {
                animationDuration: 50,
            });
            globeView.camera.camera3D.fov = 75;
            
            globeView.atmosphere.visible = false;

            function addLayerCb(layer) {
                return globeView.addLayer(layer);
            }

            // Define projection that we will use (taken from https://epsg.io/3946, Proj4js section)
            itowns.proj4.defs('EPSG:3946',
                '+proj=lcc +lat_1=45.25 +lat_2=46.75 +lat_0=46 +lon_0=3 +x_0=1700000 +y_0=5200000 +ellps=GRS80 +towgs84=0,0,0,0,0,0,0 +units=m +no_defs');

            // Add one imagery layer to the scene
            // This layer is defined in a json file but it could be defined as a plain js
            // object. See Layer* for more info.
            promises.push(itowns.Fetcher.json('./layers/JSONLayers/Ortho.json').then(addLayerCb));

            // Add two elevation layers.
            // These will deform iTowns globe geometry to represent terrain elevation.
            // promises.push(itowns.Fetcher.json('./layers/JSONLayers/WORLD_DTM.json').then(addLayerCb));
            promises.push(itowns.Fetcher.json('./layers/JSONLayers/IGN_MNT_HIGHRES.json').then(addLayerCb));

            function colorBuildings(properties) {
                if (properties.id.indexOf('bati_remarquable') === 0) {
                    return new itowns.THREE.Color(0x5555ff);
                } else if (properties.id.indexOf('bati_industriel') === 0) {
                    return new itowns.THREE.Color(0xff5555);
                }
                return new itowns.THREE.Color(0xeeeeee);
            }

            function altitudeBuildings(properties) {
                return properties.z_min - properties.hauteur - 3;
            }

            function extrudeBuildings(properties) {
                return properties.hauteur + 3;
            }


            globeView.addLayer({
                type: 'geometry',
                update: itowns.OrientedImageProcessing.update(),
                images: 'http://www.itowns-project.org/itowns-sample-data-small/images/140616/Paris-140616_0740-{sensorId}-00001_0000{imageId}.jpg',
                orientations: 'https://raw.githubusercontent.com/iTowns/iTowns2-sample-data/master/immersive/exampleParis1/panoramicsMetaDataParis.geojson',
                calibrations: 'cameraCalibration.json',
                protocol: 'orientedimage',
                id: 'demo_orientedImage',
                level: 16,
                crs: 'EPSG:2154',
                crsOut: globeView.referenceCrs,
                format: 'geojson',
                axisHelpers: false,
                cameraHelpers: false,
                sphereRadius: 50,
            }, globeView.tileLayer).then(function addWfsLayer(layer) {
                orientedImageLayer = layer;

                immersiveControl.addLayer(orientedImageLayer);
                globeView.addLayer({
                    type: 'geometry',
                    update: itowns.FeatureProcessing.update,
                    convert: itowns.Feature2Mesh.convert({
                        color: colorBuildings,
                        altitude: altitudeBuildings,
                        extrude: extrudeBuildings }),
                    onMeshCreated: (mesh) => mesh.traverse(object => object.material = orientedImageLayer.material),
                    source: {
                        protocol: 'wfs',
                        version: '2.0.0',
                        id: 'wfsBuilding',
                        url: 'http://wxs.ign.fr/72hpsel8j8nhb5qgdh07gcyp/geoportail/wfs?',
                        typeName: 'BDTOPO_BDD_WLD_WGS84G:bati_remarquable,BDTOPO_BDD_WLD_WGS84G:bati_indifferencie,BDTOPO_BDD_WLD_WGS84G:bati_industriel',
                        level: 10,
                        projection: 'EPSG:4326',
                        extent: {
                        west: 2.334,
                        east: 2.335,
                        south: 48.849,
                        north: 48.851,
                        },
                        // extent: {
                        //     west: 2.35,
                        //     east: 2.37,
                        //     south: 48.86,
                        //     north: 48.88,
                        // },
                        ipr: 'IGN',
                    },
                    // url: 'http://wxs.ign.fr/72hpsel8j8nhb5qgdh07gcyp/geoportail/wfs?',
                    // protocol: 'wfs',
                    // version: '2.0.0',
                    // id: 'WFS Buildings',
                    // typeName: 'BDTOPO_BDD_WLD_WGS84G:bati_remarquable,BDTOPO_BDD_WLD_WGS84G:bati_indifferencie,BDTOPO_BDD_WLD_WGS84G:bati_industriel',
                    // level: 16,
                    // projection: 'EPSG:4326',
                    // extent: {
                    //     west: 2.334,
                    //     east: 2.335,
                    //     south: 48.849,
                    //     north: 48.851,
                    // },
                    // ipr: 'IGN',
                    // format: 'json',
                }, globeView.tileLayer);
            });
            
            /* global itowns, document, GuiTools, globeView, promises */
            var menuGlobe = new GuiTools('menuDiv');
            menuGlobe.view = globeView;
            // Listen for globe full initialisation event
            globeView.addEventListener(itowns.GLOBE_VIEW_EVENTS.GLOBE_INITIALIZED, function () {
                // eslint-disable-next-line no-console
                console.info('Globe initialized');
                Promise.all(promises).then(function () {
                    menuGlobe.addImageryLayersGUI(globeView.getLayers(function (l) { return l.type === 'color'; }));
                    menuGlobe.addElevationLayersGUI(globeView.getLayers(function (l) { return l.type === 'elevation'; }));
                    immersiveControl.setCameraToCurrentPano();
                    
                    // uncomment to debug camera calibration
                    // debug.OrientedImageDebug.initTools(globeView, orientedImageLayer, menuGlobe.gui);

                    const d = new debug.Debug(globeView, menuGlobe.gui);
                    debug.createTileDebugUI(menuGlobe.gui, globeView, globeView.tileLayer, d);
                    for (let layer of globeView.getLayers()) {
                        if (layer.id === 'WFS Buildings') {
                            layer.whenReady.then( function _(layer) {
                                var gui = debug.GeometryDebug.createGeometryDebugUI(menuGlobe.gui, globeView, layer);
                                debug.GeometryDebug.addWireFrameCheckbox(gui, globeView, layer);
                            });
                        }
                    }
                });
            });
            
        </script>
    </body>
</html>
